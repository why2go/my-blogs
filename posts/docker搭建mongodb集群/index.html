<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="docker搭建mongodb集群" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="本文按照mongodb网站上的指导教程使用docker搭建了一个shard集群，供学习参考。" /><meta property="og:description" content="本文按照mongodb网站上的指导教程使用docker搭建了一个shard集群，供学习参考。" /><link rel="canonical" href="https://why2go.github.io/posts/docker%E6%90%AD%E5%BB%BAmongodb%E9%9B%86%E7%BE%A4/" /><meta property="og:url" content="https://why2go.github.io/posts/docker%E6%90%AD%E5%BB%BAmongodb%E9%9B%86%E7%BE%A4/" /><meta property="og:site_name" content="why2go" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-07T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="docker搭建mongodb集群" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-08-07T00:00:00+08:00","datePublished":"2021-08-07T00:00:00+08:00","description":"本文按照mongodb网站上的指导教程使用docker搭建了一个shard集群，供学习参考。","headline":"docker搭建mongodb集群","mainEntityOfPage":{"@type":"WebPage","@id":"https://why2go.github.io/posts/docker%E6%90%AD%E5%BB%BAmongodb%E9%9B%86%E7%BE%A4/"},"url":"https://why2go.github.io/posts/docker%E6%90%AD%E5%BB%BAmongodb%E9%9B%86%E7%BE%A4/"}</script><title>docker搭建mongodb集群 | why2go</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="why2go"><meta name="application-name" content="why2go"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://raw.githubusercontent.com/why2go/why2go.github.io/main/assets/img/avatar/piecat.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">why2go</a></div><div class="site-subtitle font-italic">吾生也有涯，而知也无涯。</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/why2go" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['why2go','163.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>docker搭建mongodb集群</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>docker搭建mongodb集群</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> why2go </span> 发表于 <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, 2021-08-07, 00:00 +0800" >2021-08-07<i class="unloaded">2021-08-07T00:00:00+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="934 字">5 分钟 阅读</span></div></div><div class="post-content"><p>本文按照mongodb网站上的<a href="https://docs.mongodb.com/manual/tutorial/deploy-shard-cluster/">指导教程</a>使用docker搭建了一个shard集群，供学习参考。</p><p>该配置适用于Linux系统，Mac系统上的docker网络实现与Linux不相同，宿主机与容器通信会存在问题，需要另行处理。</p><p>现有如下目录结构：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>.
├── docker-compose.yaml
└── shard-setup
    └── setup.sh
</pre></table></code></div></div><p>其中，<code class="language-plaintext highlighter-rouge">docker-compose.yaml</code>内容如下，文章撰写时，mongodb版本最新为5.0.0：</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span text-data=" YAML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.8"</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">shard-setup</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">shard-setup</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">shard-setup</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mongo:5.0.0</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">/usr/bin/bash /shard-setup/setup.sh</span>
    <span class="na">volumes</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">./shard-setup:/shard-setup</span>
    <span class="na">networks</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">mongo-shard-net</span>
    <span class="na">depends_on</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">mongos-1</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s2">"</span><span class="s">no"</span>

  <span class="na">mongos-1</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">mongos-1</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">mongos-1</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mongo:5.0.0</span>
    <span class="na">entrypoint</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s2">"</span><span class="s">mongos"</span> 
      <span class="pi">-</span> <span class="s2">"</span><span class="s">--configdb"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">cfgrs0/cfgrs0-1:27019,cfgrs0-2:27019,cfgrs0-3:27019"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">--bind_ip_all"</span>
    <span class="na">networks</span><span class="pi">:</span> 
      <span class="na">mongo-shard-net</span><span class="pi">:</span>
        <span class="na">ipv4_address</span><span class="pi">:</span> <span class="s">172.28.0.51</span>
    <span class="na">expose</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="m">27017</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure</span>
    <span class="na">depends_on</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">cfgrs0-1</span>
      <span class="pi">-</span> <span class="s">cfgrs0-2</span>
      <span class="pi">-</span> <span class="s">cfgrs0-3</span>
      <span class="pi">-</span> <span class="s">dbrs0-1</span>
      <span class="pi">-</span> <span class="s">dbrs0-2</span>
      <span class="pi">-</span> <span class="s">dbrs0-3</span>
      <span class="pi">-</span> <span class="s">dbrs1-1</span>
      <span class="pi">-</span> <span class="s">dbrs1-2</span>
      <span class="pi">-</span> <span class="s">dbrs1-3</span>

  <span class="na">cfgrs0-1</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">cfgrs0-1</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">cfgrs0-1</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mongo:5.0.0</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">/usr/bin/mongod --configsvr --replSet "cfgrs0" --bind_ip_all</span>
    <span class="na">networks</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">mongo-shard-net</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure</span>
    <span class="na">expose</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s2">"</span><span class="s">27019"</span>
  <span class="na">cfgrs0-2</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">cfgrs0-2</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">cfgrs0-2</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mongo:5.0.0</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">/usr/bin/mongod --configsvr --replSet "cfgrs0" --bind_ip_all</span>
    <span class="na">networks</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">mongo-shard-net</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure</span>
    <span class="na">expose</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s2">"</span><span class="s">27019"</span>
  <span class="na">cfgrs0-3</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">cfgrs0-3</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">cfgrs0-3</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mongo:5.0.0</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">/usr/bin/mongod --configsvr --replSet "cfgrs0" --bind_ip_all</span>
    <span class="na">networks</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">mongo-shard-net</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure</span>
    <span class="na">expose</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s2">"</span><span class="s">27019"</span>

  <span class="c1"># 配置dbrs0和dbrs1</span>
  <span class="na">dbrs0-1</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">dbrs0-1</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">dbrs0-1</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mongo:5.0.0</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">/usr/bin/mongod --shardsvr --replSet "dbrs0" --bind_ip_all</span>
    <span class="na">networks</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">mongo-shard-net</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure</span>
    <span class="na">expose</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s2">"</span><span class="s">27018"</span>
  <span class="na">dbrs0-2</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">dbrs0-2</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">dbrs0-2</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mongo:5.0.0</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">/usr/bin/mongod --shardsvr --replSet "dbrs0" --bind_ip_all</span>
    <span class="na">networks</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">mongo-shard-net</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure</span>
    <span class="na">expose</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s2">"</span><span class="s">27018"</span>
  <span class="na">dbrs0-3</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">dbrs0-3</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">dbrs0-3</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mongo:5.0.0</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">/usr/bin/mongod --shardsvr --replSet "dbrs0" --bind_ip_all</span>
    <span class="na">networks</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">mongo-shard-net</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure</span>
    <span class="na">expose</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s2">"</span><span class="s">27018"</span>

  <span class="na">dbrs1-1</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">dbrs1-1</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">dbrs1-1</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mongo:5.0.0</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">/usr/bin/mongod --shardsvr --replSet "dbrs1" --bind_ip_all</span>
    <span class="na">networks</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">mongo-shard-net</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure</span>
    <span class="na">expose</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s2">"</span><span class="s">27018"</span>
  <span class="na">dbrs1-2</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">dbrs1-2</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">dbrs1-2</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mongo:5.0.0</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">/usr/bin/mongod --shardsvr --replSet "dbrs1" --bind_ip_all</span>
    <span class="na">networks</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">mongo-shard-net</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure</span>
    <span class="na">expose</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s2">"</span><span class="s">27018"</span>
  <span class="na">dbrs1-3</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">dbrs1-3</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">dbrs1-3</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mongo:5.0.0</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">/usr/bin/mongod --shardsvr --replSet "dbrs1" --bind_ip_all</span>
    <span class="na">networks</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">mongo-shard-net</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure</span>
    <span class="na">expose</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s2">"</span><span class="s">27018"</span>

<span class="na">networks</span><span class="pi">:</span> 
  <span class="na">mongo-shard-net</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">mongo-shard-net</span>
    <span class="na">ipam</span><span class="pi">:</span> 
      <span class="na">config</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="na">subnet</span><span class="pi">:</span> <span class="s">172.28.0.0/16</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">setup.sh</code>用于设置config以及shard主从，内容如下：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre><td class="rouge-code"><pre><span class="c">#/bin/bash</span>

<span class="nv">CFGRS0_NAME</span><span class="o">=</span>cfgrs0
<span class="nv">CFGRS0_REPLICA_1</span><span class="o">=</span><span class="k">${</span><span class="nv">CFGRS0_NAME</span><span class="k">}</span><span class="nt">-1</span>
<span class="nv">CFGRS0_REPLICA_2</span><span class="o">=</span><span class="k">${</span><span class="nv">CFGRS0_NAME</span><span class="k">}</span><span class="nt">-2</span>
<span class="nv">CFGRS0_REPLICA_3</span><span class="o">=</span><span class="k">${</span><span class="nv">CFGRS0_NAME</span><span class="k">}</span><span class="nt">-3</span>

<span class="nv">CFGSVR_PORT</span><span class="o">=</span>27019

<span class="nv">DBRS0_NAME</span><span class="o">=</span>dbrs0
<span class="nv">DBRS0_REPLICA_1</span><span class="o">=</span><span class="k">${</span><span class="nv">DBRS0_NAME</span><span class="k">}</span><span class="nt">-1</span>
<span class="nv">DBRS0_REPLICA_2</span><span class="o">=</span><span class="k">${</span><span class="nv">DBRS0_NAME</span><span class="k">}</span><span class="nt">-2</span>
<span class="nv">DBRS0_REPLICA_3</span><span class="o">=</span><span class="k">${</span><span class="nv">DBRS0_NAME</span><span class="k">}</span><span class="nt">-3</span>

<span class="nv">DBRS1_NAME</span><span class="o">=</span>dbrs1
<span class="nv">DBRS1_REPLICA_1</span><span class="o">=</span><span class="k">${</span><span class="nv">DBRS1_NAME</span><span class="k">}</span><span class="nt">-1</span>
<span class="nv">DBRS1_REPLICA_2</span><span class="o">=</span><span class="k">${</span><span class="nv">DBRS1_NAME</span><span class="k">}</span><span class="nt">-2</span>
<span class="nv">DBRS1_REPLICA_3</span><span class="o">=</span><span class="k">${</span><span class="nv">DBRS1_NAME</span><span class="k">}</span><span class="nt">-3</span>

<span class="nv">DBSVR_PORT</span><span class="o">=</span>27018

<span class="k">until </span>mongosh <span class="nt">--host</span> <span class="k">${</span><span class="nv">CFGRS0_REPLICA_1</span><span class="k">}</span> <span class="nt">--port</span> <span class="k">${</span><span class="nv">CFGSVR_PORT</span><span class="k">}</span> <span class="nt">--quiet</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
exit
</span><span class="no">EOF
</span><span class="k">do
  </span><span class="nb">sleep </span>5
<span class="k">done
</span>mongosh <span class="nt">--host</span> <span class="k">${</span><span class="nv">CFGRS0_REPLICA_1</span><span class="k">}</span> <span class="nt">--port</span> <span class="k">${</span><span class="nv">CFGSVR_PORT</span><span class="k">}</span> <span class="nt">--quiet</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
rs.initiate(
  {
    _id: "</span><span class="k">${</span><span class="nv">CFGRS0_NAME</span><span class="k">}</span><span class="sh">",
    configsvr: true,
    members: [
      { _id : 0, host : "</span><span class="k">${</span><span class="nv">CFGRS0_REPLICA_1</span><span class="k">}</span><span class="sh">:</span><span class="k">${</span><span class="nv">CFGSVR_PORT</span><span class="k">}</span><span class="sh">", priority: 2 },
      { _id : 1, host : "</span><span class="k">${</span><span class="nv">CFGRS0_REPLICA_2</span><span class="k">}</span><span class="sh">:</span><span class="k">${</span><span class="nv">CFGSVR_PORT</span><span class="k">}</span><span class="sh">", priority: 1 },
      { _id : 2, host : "</span><span class="k">${</span><span class="nv">CFGRS0_REPLICA_3</span><span class="k">}</span><span class="sh">:</span><span class="k">${</span><span class="nv">CFGSVR_PORT</span><span class="k">}</span><span class="sh">", priority: 1 }
    ]
  }
)
</span><span class="no">EOF

</span><span class="k">for </span>rs <span class="k">in </span>0 1
<span class="k">do
  until </span>mongosh <span class="nt">--host</span> <span class="sb">`</span><span class="nb">eval echo</span> <span class="s1">'$'</span><span class="o">{</span>DBRS<span class="s2">"</span><span class="k">${</span><span class="nv">rs</span><span class="k">}</span><span class="s2">"</span>_REPLICA_1<span class="o">}</span><span class="sb">`</span> <span class="nt">--port</span> <span class="k">${</span><span class="nv">DBSVR_PORT</span><span class="k">}</span> <span class="nt">--quiet</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
exit
</span><span class="no">EOF
</span>  <span class="k">do
    </span><span class="nb">sleep </span>5
  <span class="k">done
</span>mongosh <span class="nt">--host</span> <span class="sb">`</span><span class="nb">eval echo</span> <span class="s1">'$'</span><span class="o">{</span>DBRS<span class="s2">"</span><span class="k">${</span><span class="nv">rs</span><span class="k">}</span><span class="s2">"</span>_REPLICA_1<span class="o">}</span><span class="sb">`</span> <span class="nt">--port</span> <span class="k">${</span><span class="nv">DBSVR_PORT</span><span class="k">}</span> <span class="nt">--quiet</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
rs.initiate(
  {
    _id: "`eval echo '</span><span class="nv">$'</span><span class="sh">{DBRS"</span><span class="k">${</span><span class="nv">rs</span><span class="k">}</span><span class="sh">"_NAME}`",
    members: [
      { _id : 0, host : "`eval echo '</span><span class="nv">$'</span><span class="sh">{DBRS"</span><span class="k">${</span><span class="nv">rs</span><span class="k">}</span><span class="sh">"_REPLICA_1}`:</span><span class="k">${</span><span class="nv">DBSVR_PORT</span><span class="k">}</span><span class="sh">", priority: 2 },
      { _id : 1, host : "`eval echo '</span><span class="nv">$'</span><span class="sh">{DBRS"</span><span class="k">${</span><span class="nv">rs</span><span class="k">}</span><span class="sh">"_REPLICA_2}`:</span><span class="k">${</span><span class="nv">DBSVR_PORT</span><span class="k">}</span><span class="sh">", priority: 1 },
      { _id : 2, host : "`eval echo '</span><span class="nv">$'</span><span class="sh">{DBRS"</span><span class="k">${</span><span class="nv">rs</span><span class="k">}</span><span class="sh">"_REPLICA_3}`:</span><span class="k">${</span><span class="nv">DBSVR_PORT</span><span class="k">}</span><span class="sh">", priority: 1 }
    ]
  }
)
</span><span class="no">EOF
</span><span class="k">done</span>

<span class="c"># mongos --configdb ${CFGRS0_NAME}/${CFGRS0_REPLICA_1}:${CFGSVR_PORT},\</span>
<span class="c"># ${CFGRS0_REPLICA_2}:${CFGSVR_PORT},${CFGRS0_REPLICA_3}:${CFGSVR_PORT} \</span>
<span class="c"># --bind_ip_all &amp;</span>

<span class="nv">MONGOS</span><span class="o">=</span>mongos-1

<span class="c"># 配置shard</span>
<span class="k">until </span>mongosh <span class="nt">--host</span> <span class="k">${</span><span class="nv">MONGOS</span><span class="k">}</span> <span class="nt">--quiet</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
exit
</span><span class="no">EOF
</span><span class="k">do
  </span><span class="nb">sleep </span>5
<span class="k">done

</span>mongosh <span class="nt">--host</span> <span class="k">${</span><span class="nv">MONGOS</span><span class="k">}</span> <span class="nt">--quiet</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
sh.addShard("</span><span class="k">${</span><span class="nv">DBRS0_NAME</span><span class="k">}</span><span class="sh">/</span><span class="k">${</span><span class="nv">DBRS0_REPLICA_1</span><span class="k">}</span><span class="sh">:</span><span class="k">${</span><span class="nv">DBSVR_PORT</span><span class="k">}</span><span class="sh">,</span><span class="k">${</span><span class="nv">DBRS0_REPLICA_2</span><span class="k">}</span><span class="sh">:</span><span class="k">${</span><span class="nv">DBSVR_PORT</span><span class="k">}</span><span class="sh">,</span><span class="k">${</span><span class="nv">DBRS0_REPLICA_3</span><span class="k">}</span><span class="sh">:</span><span class="k">${</span><span class="nv">DBSVR_PORT</span><span class="k">}</span><span class="sh">")
sh.addShard("</span><span class="k">${</span><span class="nv">DBRS1_NAME</span><span class="k">}</span><span class="sh">/</span><span class="k">${</span><span class="nv">DBRS1_REPLICA_1</span><span class="k">}</span><span class="sh">:</span><span class="k">${</span><span class="nv">DBSVR_PORT</span><span class="k">}</span><span class="sh">,</span><span class="k">${</span><span class="nv">DBRS1_REPLICA_2</span><span class="k">}</span><span class="sh">:</span><span class="k">${</span><span class="nv">DBSVR_PORT</span><span class="k">}</span><span class="sh">,</span><span class="k">${</span><span class="nv">DBRS1_REPLICA_3</span><span class="k">}</span><span class="sh">:</span><span class="k">${</span><span class="nv">DBSVR_PORT</span><span class="k">}</span><span class="sh">")
</span><span class="no">EOF

</span></pre></table></code></div></div><p>使用<code class="language-plaintext highlighter-rouge">docker-compose up</code>即可启动集群，使用<code class="language-plaintext highlighter-rouge">docker-compose down --volumes</code>即可停止并删除集群。</p><p>使用<code class="language-plaintext highlighter-rouge">docker-compose stop</code>可以保存此次启动的集群容器，下次使用<code class="language-plaintext highlighter-rouge">docker-compose start</code>启动既可以恢复，可以看到上次启动时mongodb保存的数据。</p><p>PS：仅使用<code class="language-plaintext highlighter-rouge">docker-compose down</code>可能会致使磁盘空间不断减小，每次挂载的volume在<code class="language-plaintext highlighter-rouge">/var/lib/docker</code>目录下会越积越多。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/mongodb/'>mongodb</a>, <a href='/categories/docker/'>docker</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >docker</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=docker搭建mongodb集群 - why2go&url=https://why2go.github.io/posts/docker%E6%90%AD%E5%BB%BAmongodb%E9%9B%86%E7%BE%A4/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=docker搭建mongodb集群 - why2go&u=https://why2go.github.io/posts/docker%E6%90%AD%E5%BB%BAmongodb%E9%9B%86%E7%BE%A4/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=docker搭建mongodb集群 - why2go&url=https://why2go.github.io/posts/docker%E6%90%AD%E5%BB%BAmongodb%E9%9B%86%E7%BE%A4/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="" title-succeed=""> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>热门标签</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/bloom/">bloom</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/jwt/">jwt</a> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/openssl/">openssl</a> <a class="post-tag" href="/tags/redis/">redis</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/redis%E4%BD%BF%E7%94%A8bloom-filter/"><div class="card-body"> <span class="timeago small" >06-09<i class="unloaded">2022-06-09T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>redis使用bloom filter</h3><div class="text-muted small"><p> 什么是布隆过滤器？ 怎么用Redis实现布隆过滤器？ Redis组件加载 Redis Lab 和 阿里云增强型Redis</p></div></div></a></div><div class="card"> <a href="/posts/OpenSSL/"><div class="card-body"> <span class="timeago small" >2021-09-07<i class="unloaded">2021-09-07T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>OpenSSL</h3><div class="text-muted small"><p> OpenSSL TLS、证书、CA、公钥私钥等概念，在OpenSSL的实现中都有体现。 可以通过对OpenSSL的学习，来逐步地了解上述的概念。 描述 OpenSSL是一个密码学工具箱，它实现了SSL（v2，v3）以及TLSv1，以及这些协议所使用到的密码学工具。 它的主要用途有以下几个： 创建并管理私钥、公钥以及参数 公钥加密操作 创建X.509证书、CSR（证书...</p></div></div></a></div><div class="card"> <a href="/posts/JWT/"><div class="card-body"> <span class="timeago small" >2021-09-07<i class="unloaded">2021-09-07T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JWT</h3><div class="text-muted small"><p> JWT jwt由三部分组成：Header、Playload、Signature/Encryption Header和Playload是JSON对象。 签名和加密依赖于使用的算法，如果jwt不进行签名或加密，则没有这一部分。 Header 头部用于说明jwt使用何种算法签名或加密，alg字段是必须要有的 不加密jwt头部只有一个字段： 1 2 3 { "alg": "no...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="上一篇"><p>-</p></span> <a href="/posts/JWT/" class="btn btn-outline-primary" prompt="下一篇"><p>JWT</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/why2go">why2go</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">热门标签</h4><a class="post-tag" href="/tags/bloom/">bloom</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/jwt/">jwt</a> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/openssl/">openssl</a> <a class="post-tag" href="/tags/redis/">redis</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
